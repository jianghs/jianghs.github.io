---
title: 深入理解java web-java io
date: 2019-12-10 21:47:03
tags: Java
categories: coding
---
## java io 机制

### io类库的基本架构

1. 传输格式

    基于字节操作：InputStream和OutputStream

    基于字符操作：Writer和Reader
2. 传输方式

    基于磁盘操作：File

    基于网络操作：Socket

无论磁盘或者网络传输，最小的存储单元都是字节而不是字符，为什么需要基于字符操作？

因为程序中操作的数据是字符格式，而字符转成字节耗时，而且有编码的问题。

## 字节和字符的转换

1. InputStreamReader 字节转字符
2. OutStreamWriter 字符转字节

## 磁盘IO工作机制

### 标准访问文件方式

读：从缓存中读取，有则取出，没有则从磁盘读取，然后缓存在操作系统缓存中。

写：用户地址空间复制到内存地址空间缓存后，对于应用程序而言就是写完毕。

### 直接IO方式

应用程序直接访问磁盘空间，而不经过内存地址空间缓存。

### 同步访问文件方式

写：只有当数据全部写入到磁盘时才会认为写入完毕。
性能较差，只有对数据安全性比较高的场景才会有要求。

### 异步访问文件方式

当访问数据的请求发出去后，应用程序线程不会阻塞，而是去处理其他任务。
可以提高应用程序效率而无法提高文件访问效率。

### 内存映射方式

将内存中某块区域与磁盘中的文件关联，访问内存区域时相当于直接访问磁盘文件。

## 网络IO工作机制

影响网络传输的因素

1. 网络带宽
2. 传输距离
3. TCP拥塞控制

## java socket 工作机制

客户端：Socket 实例，创建实例成功之前将进行tcp三次握手。

服务端：SocketServer 实例。

### 数据传输

1. 客户端每个Socket实例都会有一个InputStream和一个OutputStream，并通过这两个对象来交换数据。
2. 写入端将数据写入到OutputStream对应的SendQ队列中，读取端从InputStream对应的RecvQ队列中读取数据。
3. 网络io的读取和写入有一个协同的过程，如果两边同时传输数据，可能产生死锁。

## NIO的工作方式

BIO的弊端

1. 难以解决线程数过多的问题
2. 线程优先级难以控制
3. 线程并发

## NIO工作机制

Channel:比Socket更加具体，可以看作是某个具体的交通工具

Selector:调度系统，轮循每个Channel的状态。

Buffer:比Stream更加具体，可以看作车辆上的座位。

### 两个线程

一个线程专门监听客户端的连接请求，以阻塞的方式。

一个线程专门处理连接请求，以非阻塞的方式。

## Buffer的工作方式

一组基本数据类型的元素列表。

capacity:缓冲区数组的总长度。

position:下一个要操作的数据元素的位置。

limit:缓冲区数组不可操作的元素位置。

mark:记录当前position前一个位置或默认为0。

## NIO数据访问方式

1. FileChannel.TransferTo/FileChannel.TransferFrom 数据直接在内核空间中移动

2. FileChannel.TransferMap 将文件按照一定大小块映射为内存空间，将程序访问这个内存空间时将直接操作这个文件，省去从内核空间到用户空间的复制的过程，适合大文件读的操作。

## IO调优

1、磁盘IO优化

- 增加缓存，减少磁盘访问次数。
- 合适的磁盘管理和磁盘策略。
- 设计合适的磁盘存储数据块和访问这些数据块的策略。
- 合理的RAID策略

2、网络IO优化

- 减少网络交互次数
- 减少网络传输数据量大小
- 尽量减少编码

## 同步和异步

同步:一个任务完成依赖另一个任务，可靠的任务序列

异步:不可靠的任务序列

同步可以保证任务的可靠性，异步可以提升任务的性能。

## 阻塞和非阻塞

阻塞:cpu等待任务完成后，再执行下一个任务。

非阻塞:任务执行时，cpu执行下一个任务。

非阻塞可以提高cpu利用率，但是会增加线程切换。

## java io中的适配器模式

InputStreamReader把InputStream适配成Reader

OutputStreamWriter把OutputStream适配成Writer

## java io中的装饰器模式

目的是增强原有接口的功能

FilterInputStream、BufferedInputStream
