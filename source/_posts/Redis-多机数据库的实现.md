---
title: Redis-多机数据库的实现
date: 2019-07-29 15:02:36
tags: Redis
categories: coding
---
## 复制

通过 `SLAVEOF` 命令或者设置 slaveof 选项，启动复制功能。

### 旧版复制功能的实现

* 同步（SYNC）：将从服务器数据更新至主服务器当前所处的数据状态。
* 命令传播（command propagate）:在主服务器数据发生修改，导致主从服务器不一致时，让主从服务器回到一致状态。

#### 同步

1. 从服务器向主服务器发送 SYNC 命令。
2. 收到 SYNC 命令的主服务器执行 BGSAVE 命令，在后台生成一个 RDB 文件，并使用一个缓冲区记录从现在开始执行的所有写命令。
3. 当主服务器的 BGSAVE 命令执行完毕时，主服务器会将生成的 RDB 文件发送给从服务器，从服务器接收并载入这个 RDB 文件，将自己的数据库状态更新至主服务器执行 BGSAVE 时的数据库状态。
4. 主服务器将记录在缓冲区的所有写命令发送给从服务器，从服务器执行这些写命令，将数据库状态更新到主服务器数据库当前所处的状态。

#### 命令传播

主服务器对从服务器执行命令传播操作。

### 旧版复制功能的缺陷

断线后重新复制，主服务器接收到 SYNC 命令后会将所有的数据生成 RDB 文件，导致效率低下。

### 新版复制功能的实现

`PSYNC` 命令具备完整重同步和部分重同步两种模式。

完整重同步用于初次复制情况，与 SYNC 功能一致。

部分重同步用于断线后重新复制的情况，断线后，如果条件允许，只复制断线期间的写命令。

1. 从服务器向主服务器发送 PSYNC 命令。
2. 主服务器向从服务器回复 +CONTINUE 回复，表示执行部分重同步。
3. 从服务器接收 +CONTINUE 回复，准备执行部分重同步。

### 部分重同步的实现

#### 主服务器的复制偏移量和从服务器的复制偏移量

1. 主服务器每次向从服务器传播 N 个字节数据时，就将自己的复制偏移量加 N。
2. 从服务器接收到 N 个字节数据时，就将自己的复制偏移量加 N。

如果主从服务器的复制偏移量相等，则数据库状态一致。否则处于不一致的状态。

#### 主服务器的复制积压缓冲区

复制积压缓冲区是主服务器维护的一个固定长度、先进先出的队列。默认大小 1 MB。

积压缓冲区会记录每个字节对应的偏移量。

1. 当主服务器进行命令传播时，不仅会把所有写命令发给所有从服务器，还会将写命令入队到复制积压缓冲区。
2. 主服务器接收到从服务器的 PSYNC 命令后，如果从服务器复制偏移量之后的数据仍然存在于积压缓冲区，那么主服务器会对从服务器执行部分重同步。
3. 否则执行完整重同步。

#### 服务器的运行 ID

从服务器进行初次复制时，主服务器会将自己的服务器 ID 发送给从服务器，从服务器会保存这个 ID。

如果从服务器保存的 ID 与 重新连接的服务器 ID 相同，主服务器可以继续尝试部分重同步。否则进行完整重同步。

### PSYNC 命令的实现

![PSYNC 情况](https://raw.githubusercontent.com/jianghs/myBlogPicBed/master/redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E6%88%AA%E5%9B%BE/PSYNC_PROCESS.png)

### 复制的实现

1. 设置主服务器的地址和端口

    从服务器的 redisServer 的 masterhost 属性和 masterport 属性记录以上信息。

2. 建立套接字连接

    从服务器是主服务器的客户端。

3. 发送 PING 命令

    * 检查套接字是否读写正常。
    * 检查主服务器是否可以正常处理命令请求。

    ![ping](https://raw.githubusercontent.com/jianghs/myBlogPicBed/master/redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E6%88%AA%E5%9B%BE/PING.png)

4. 身份验证

    ![verify](https://raw.githubusercontent.com/jianghs/myBlogPicBed/master/redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E6%88%AA%E5%9B%BE/verify.png)

5. 发送端口信息

    从服务器向主服务器发送自己的端口信息，主服务器将从服务器的端口记录在 redisClient 中。

6. 进行同步

    从服务器向主服务器发送 PSYNC 命令，执行同步操作。

    执行同步前，只有从服务器是主服务器是客户端，执行同步后，主从服务器互为客户端。

7. 进行命令传播

    完成同步后，主从服务器就会进入命令传播阶段。

### 心跳检测

命令传播阶段，从服务器默认每秒一次的频率，向主服务器发送以下命令：

```redis
REPLCONF ACK <replication_offset>
```

作用：

* 检测主从服务器网络连接状态
* 辅助实现 min-slaves 选项
* 检测命令丢失

#### 检测主从服务器网络连接状态

如果主服务器一秒内没有收到从服务器发送的命令，认为网络有问题。

#### 辅助实现 min-slaves 选项

min-salves-to-write 和 min-slaves-max-lag 防止主服务器在不安全的情况下执行写操作。

#### 检测命令丢失

与部分重同步原理类似，区别在于检测命令丢失不是在断线的情况下。

## Sentinel

哨兵解决方案：由一个或者多个 sentinel 实例组成的 sentinel 系统可以监视任意多个主服务器以及这些主服务器属下的所有从服务器。

### 启动并初始化 Sentinel

### 获取主服务器信息

### 获取从服务器信息

### 向主服务器和从服务器发送信息

### 接收来自主服务器和从服务器的频道信息

### 检测主观下线状态

### 检测客观下线状态

### 选举领头 Sentinel 238

### 故障转移

## 集群

### 节点

### 指派槽

### 在集群中执行命令

### 重新分片

### ASK 错误

### 复制与故障转移

### 消息
