---
title: Redis 单机数据库的实现
date: 2019-07-23 09:52:23
tags: Redis
categories: coding
---
## 数据库

### 服务器中的数据库

结构如下：

```c
struct redisServer {
  // 保存着服务器上所有数据库的数组
  redisDb *db;
  // 服务器的数据库数量
  int dbnum;
}
```

初始化的时候会根据 dbnum 决定数据库的数量，默认为16。

### 切换数据库

默认情况下，Redis 客户端的目标数据库是0号数据库。

```c
struct redisClient {
  // 记录客户端当前正在使用的数据库
  redisDb *db;
}
```

通过修改 redisClient.db 指针，让它指向不同的数据库，从而实现切换数据库的功能——这个是 select 命令的实现原理。

### 数据库键空间

Redis 是一个键值对数据库服务器，服务器中的每个数据库结构用 dict 字典保存所有的键值对。这个字典被称为键空间。

键空间的键，也就是数据库的键，每个键都是一个字符串对象。

键空间的值，也是数据库的值，每个值可以是字符串对象、列表对象、哈希表对象、集合对象、有序集合对象中的任一 Redis 对象。

#### 添加新键

实际是将一个新键值添加到键空间字典里面。

```redis
SET key "value"
```

#### 删除键

实际是在键空间里删除对应的键值对对象。

```redis
DEL key
```

#### 更新键

实际是对键空间的键对应的值对象进行更新。

```redis
SET key "newvalue"
```

#### 对键取值

在键空间取出键对应的值对象。

```redis
GET key
```

#### 其他键空间操作

|操作|说明|
| --- | --- |
| FLUSHDB | 清除数据库 |
| RANDOMKEY | 随机返回数据库的一个 key |
| DBSIZE | 获取数据库键数量 |

#### 读写键空间的维护操作

* 读取一个键之后，服务器会根据键是否存在更新服务器的键空间命中次数或不命中次数。

* 读取一个键后，服务器更新这个键的 LRU 时间。

* 如果服务器读取一个键时，发现键已过期，服务器会先删除过期键，然后进行后续操作。

* 如果客户端会用 WATCH 命令监控了某个键，那么服务器在对被监控的键进行修改后，会将这个键标记为脏（dirty）,从而让事务程序注意这个键已被修改。

* 服务器每修改一次键，则会对脏键计数器加一，这个计数器会触发服务器的持久化以及复制操作。

* 如果服务器配置了通知功能，在对键进行修改之后，服务器会根据配置发送相应的数据库通知。

### 设置键的生存时间或过期时间

* 设置生存时间

  ```Redis
  EXPIRE keyname 5
  ```

* 设置过期时间点

  ```Redis
  EXPIREAT keyname 111231231
  ```

#### 设置过期时间

* EXPIRE \<key\> \<ttl\> 将键 key 的生存时间设置为 ttl 秒。
* PEXPIRE \<key\> \<ttl\> 将键 key 的生存时间设置为 ttl 毫秒。
* EXPIREAT \<key\> \<timestamp\> 将键 key 的过期时间设置为 timestamp 指定的秒数时间戳。
* PEXPIREAT \<key\> \<timestamp\> 将键 key 的生存时间设置为  timestamp 指定的毫秒时间戳。

都是根据 PEXPIREAT 命令转换来执行。

#### 保存过期时间

过期字典的键是一个指针，这个指针指向键空间的某个键对象。

过期字典的值是一个 long 类型的整数，这个整数保存了键所指向的数据库键的过期时间-一个毫秒精度的时间戳。

#### 移除过期时间

PERSIST 命令可以移除一个键的过期时间。

#### 计算并返回剩余生存时间

TTL 命令以秒为单位返回键的剩余生存时间。

PTTL 命令以毫秒为单位返回键的剩余生存时间。

#### 过期键的判定

1. 检查给定键是否存在于过期字典，如果存在，取得键的过期时间。
2. 如果当前时间戳大于过期时间，那么键已过期。

### 过期键删除策略

* 定时删除：
* 惰性删除：
* 定期删除：

### Redis 的过期键删除策略

### AOF、RDB 和复制功能对过期键的处理

### 数据库通知

## RDB 持久化

## AOF 持久化

## 事件

## 客户端

## 服务器
